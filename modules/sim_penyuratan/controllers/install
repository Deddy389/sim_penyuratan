<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
/**
 * Installation script for SIM Penyuratan
 *
 * @author No-CMS Module Generator
 */
class Install extends CMS_Module_Installer {
    /////////////////////////////////////////////////////////////////////////////
    // Default Variables
    /////////////////////////////////////////////////////////////////////////////

    protected $DEPENDENCIES = array();
    protected $NAME         = 'admin.sim_penyuratan';
    protected $DESCRIPTION  = 'Another cool module generated by Nordrassil ...';
    protected $VERSION      = '0.0.0';


    /////////////////////////////////////////////////////////////////////////////
    // Default Functions
    /////////////////////////////////////////////////////////////////////////////

    // ACTIVATION
    protected function do_activate(){
        $this->remove_all();
        $this->build_all();
    }

    // DEACTIVATION
    protected function do_deactivate(){
        $this->backup_database(array(
            $this->cms_complete_table_name('folder'),
            $this->cms_complete_table_name('permohonan_cuti'),
            $this->cms_complete_table_name('permohonan_peng_data'),
            $this->cms_complete_table_name('permohonan_riset'),
            $this->cms_complete_table_name('ket_tdk_terima_beasiswa'),
            $this->cms_complete_table_name('ket_lulusan'),
            $this->cms_complete_table_name('kelakuan_baik'),
            $this->cms_complete_table_name('mas_jurusan'),
            $this->cms_complete_table_name('aktif_kuliah'),
            $this->cms_complete_table_name('master_hal'),
            $this->cms_complete_table_name('pkl'),
            $this->cms_complete_table_name('konfigurasi')
        ));
        $this->remove_all();
    }

    // UPGRADE
    protected function do_upgrade($old_version){
        // Add your migration logic here.
    }

    // OVERRIDE THIS FUNCTION TO PROVIDE "Module Setting" FEATURE
    public function setting(){
        $module_directory = $this->cms_module_path();
        $data = array();
        $data['IS_ACTIVE'] = $this->IS_ACTIVE;
        $data['module_directory'] = $module_directory;
        if(!$this->IS_ACTIVE){
            // get setting
            $module_table_prefix = $this->input->post('module_table_prefix');
            $module_prefix       = $this->input->post('module_prefix');
            // set values
            if(isset($module_table_prefix) && $module_table_prefix !== FALSE){
                cms_module_config($module_directory, 'module_table_prefix', $module_table_prefix);
            }
            if(isset($module_prefix) && $module_prefix !== FALSE){
                cms_module_prefix($module_directory, $module_prefix);
            }
            // get values
            $data['module_table_prefix'] = cms_module_config($module_directory, 'module_table_prefix');
            $data['module_prefix']       = cms_module_prefix($module_directory);
        }
        $this->view($module_directory.'/install_setting', $data, 'main_module_management');
    }

    /////////////////////////////////////////////////////////////////////////////
    // Private Functions
    /////////////////////////////////////////////////////////////////////////////

    // REMOVE ALL NAVIGATIONS, WIDGETS, AND PRIVILEGES
    private function remove_all(){
        $module_path = $this->cms_module_path();

        // remove navigations
        $this->remove_navigation($this->cms_complete_navigation_name('manage_konfigurasi'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_pkl'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_master_hal'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_aktif_kuliah'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_mas_jurusan'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_kelakuan_baik'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_ket_lulusan'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_ket_tdk_terima_beasiswa'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_permohonan_riset'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_permohonan_peng_data'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_permohonan_cuti'));
        $this->remove_navigation($this->cms_complete_navigation_name('manage_folder'));


        // remove parent of all navigations
        $this->remove_navigation($this->cms_complete_navigation_name('index'));
        
        // drop tables
        $this->dbforge->drop_table($this->cms_complete_table_name('konfigurasi'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('pkl'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('master_hal'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('aktif_kuliah'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('mas_jurusan'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('kelakuan_baik'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('ket_lulusan'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('ket_tdk_terima_beasiswa'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('permohonan_riset'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('permohonan_peng_data'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('permohonan_cuti'), TRUE);
        $this->dbforge->drop_table($this->cms_complete_table_name('folder'), TRUE);
    }

    // CREATE ALL NAVIGATIONS, WIDGETS, AND PRIVILEGES
    private function build_all(){
        $module_path = $this->cms_module_path();

        // parent of all navigations
        $this->add_navigation($this->cms_complete_navigation_name('index'), 'Sim Penyuratan',
            $module_path.'/sim_penyuratan', $this->PRIV_EVERYONE);

        // add navigations
        $this->add_navigation($this->cms_complete_navigation_name('manage_folder'), 'Manage Folder',
            $module_path.'/manage_folder', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_permohonan_cuti'), 'Manage Permohonan Cuti',
            $module_path.'/manage_permohonan_cuti', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_permohonan_peng_data'), 'Manage Surat Permohonan Pengambilan Data',
            $module_path.'/manage_permohonan_peng_data', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_permohonan_riset'), 'Manage Surat Permohonan Riset',
            $module_path.'/manage_permohonan_riset', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_ket_tdk_terima_beasiswa'), 'Manage Surat Ket. Tidak Menerima Beasiswa',
            $module_path.'/manage_ket_tdk_terima_beasiswa', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_ket_lulusan'), 'Manage Keterangan Lulusan',
            $module_path.'/manage_ket_lulusan', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_kelakuan_baik'), 'Manage Surat Ket. Kelakuan Baik',
            $module_path.'/manage_kelakuan_baik', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_mas_jurusan'), 'Manage Master Jurusan',
            $module_path.'/manage_mas_jurusan', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_aktif_kuliah'), 'Manage Surat Ket. Aktif Kuliah',
            $module_path.'/manage_aktif_kuliah', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_master_hal'), 'Manage Master Hal',
            $module_path.'/manage_master_hal', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_pkl'), 'Manage PKL/Magang',
            $module_path.'/manage_pkl', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );
        $this->add_navigation($this->cms_complete_navigation_name('manage_konfigurasi'), 'Manage Konfigurasi',
            $module_path.'/manage_konfigurasi', $this->PRIV_AUTHORIZED, $this->cms_complete_navigation_name('index')
        );

        
        // create tables
        // folder
        $fields = array(
            'id_folder'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nama'=> array("type"=>'varchar', "constraint"=>30, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_folder', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('folder'));

        // permohonan_cuti
        $fields = array(
            'id_permohonan_cuti'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE),
            'alamat'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'no_telp'=> array("type"=>'bigint', "constraint"=>11, "null"=>TRUE),
            'alasan_cuti'=> array("type"=>'text', "null"=>TRUE),
            'tahun_ajaran'=> array("type"=>'varchar', "constraint"=>11, "null"=>TRUE),
            'dosen_pa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_permohonan_cuti', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('permohonan_cuti'));

        // permohonan_peng_data
        $fields = array(
            'id_permohonan_peng_data'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nomor_surat'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'lampiran'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'kepada'=> array("type"=>'varchar', "constraint"=>200, "null"=>TRUE),
            'di'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_permohonan_peng_data', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('permohonan_peng_data'));

        // permohonan_riset
        $fields = array(
            'id_permohonan_riset'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nomor_surat'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'lampiran'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'kepada'=> array("type"=>'varchar', "constraint"=>200, "null"=>TRUE),
            'di'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE),
            'judul_penelitian'=> array("type"=>'text', "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_permohonan_riset', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('permohonan_riset'));

        // ket_tdk_terima_beasiswa
        $fields = array(
            'id_ket_tdk_terima_beasiswa'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'no_surat'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'tempat_lahir'=> array("type"=>'varchar', "constraint"=>30, "null"=>TRUE),
            'tanggal_lahir'=> array("type"=>'date', "null"=>TRUE),
            'fk_id_jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE),
            'semester'=> array("type"=>'set', "constraint"=>array("Genap","Ganjil"), "null"=>TRUE),
            'tahun_akademis'=> array("type"=>'varchar', "constraint"=>11, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_ket_tdk_terima_beasiswa', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('ket_tdk_terima_beasiswa'));

        // ket_lulusan
        $fields = array(
            'id_ket_lulusan'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'tempat_lahir'=> array("type"=>'varchar', "constraint"=>30, "null"=>TRUE),
            'tanggal_lahir'=> array("type"=>'date', "null"=>TRUE),
            'keterangan'=> array("type"=>'text', "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_ket_lulusan', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('ket_lulusan'));

        // kelakuan_baik
        $fields = array(
            'id_kelakuan_baik'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nomor_surat'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'tempat_lahir'=> array("type"=>'varchar', "constraint"=>30, "null"=>TRUE),
            'tanggal_lahir'=> array("type"=>'date', "null"=>TRUE),
            'semester'=> array("type"=>'set', "constraint"=>array("Genap","Ganjil"), "null"=>TRUE),
            'tahun_akademis'=> array("type"=>'varchar', "constraint"=>11, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_kelakuan_baik', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('kelakuan_baik'));

        // mas_jurusan
        $fields = array(
            'id_jurusan'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nama_jurusan'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'ketua_jurusan'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'pangkat'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_jurusan', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('mas_jurusan'));

        // aktif_kuliah
        $fields = array(
            'id_aktif_kuliah'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nomor_surat'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'tempat_lahir'=> array("type"=>'varchar', "constraint"=>30, "null"=>TRUE),
            'tanggal_lahir'=> array("type"=>'date', "null"=>TRUE),
            'fk_id_jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE),
            'semester'=> array("type"=>'set', "constraint"=>array("Genap","Ganjil"), "null"=>TRUE),
            'tahun_akademis'=> array("type"=>'varchar', "constraint"=>11, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_aktif_kuliah', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('aktif_kuliah'));

        // master_hal
        $fields = array(
            'id_hal'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'hal'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_hal', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('master_hal'));

        // pkl
        $fields = array(
            'id_pkl'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nomor'=> array("type"=>'int', "constraint"=>4, "null"=>TRUE),
            'lampiran'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'fk_id_hal'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE),
            'dari_tanggal'=> array("type"=>'date', "null"=>TRUE),
            'sampai_tangal'=> array("type"=>'date', "null"=>TRUE),
            'nama_mahasiswa'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'npm'=> array("type"=>'bigint', "constraint"=>15, "null"=>TRUE),
            'fk_id_jurusan'=> array("type"=>'int', "constraint"=>2, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_pkl', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('pkl'));

        // konfigurasi
        $fields = array(
            'id_konfigurasi'=> $this->TYPE_INT_UNSIGNED_AUTO_INCREMENT,
            'nama_instansi'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'alamat'=> array("type"=>'varchar', "constraint"=>100, "null"=>TRUE),
            'status_akreditasi'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'nama_puket'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE),
            'pangkat_puket'=> array("type"=>'varchar', "constraint"=>50, "null"=>TRUE)
        );
        $this->dbforge->add_field($fields);
        $this->dbforge->add_key('id_konfigurasi', TRUE);
        $this->dbforge->create_table($this->cms_complete_table_name('konfigurasi'));

        
    }

    // EXPORT DATABASE
    private function backup_database($table_names, $limit = 100){         
        if($this->db->platform() == 'mysql' || $this->db->platform() == 'mysqli'){
            $module_path = $this->cms_module_path();
            $this->load->dbutil();
            $sql = '';
            
            // create DROP TABLE syntax
            for($i=count($table_names)-1; $i>=0; $i--){
                $table_name = $table_names[$i];
                $sql .= 'DROP TABLE IF EXISTS `'.$table_name.'`; '.PHP_EOL;
            }
            if($sql !='')$sql.= PHP_EOL;

            // create CREATE TABLE and INSERT syntax 
            
            $prefs = array(
                    'tables'      => $table_names,
                    'ignore'      => array(),
                    'format'      => 'txt',
                    'filename'    => 'mybackup.sql',
                    'add_drop'    => FALSE,
                    'add_insert'  => TRUE,
                    'newline'     => PHP_EOL
                  );
            $sql.= @$this->dbutil->backup($prefs);        

            //write file
            $file_name = 'backup_'.date('Y-m-d_G:i:s').'.sql';
            file_put_contents(
                    BASEPATH.'../modules/'.$module_path.'/assets/db/'.$file_name,
                    $sql
                );
        }       

    }
}
